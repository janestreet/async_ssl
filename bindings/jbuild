(rule
 ((targets (openssl-ccopt.sexp
            openssl-cclib.sexp
            openssl-ccopt
            openssl-cclib))
  (deps    (openssl-flags.sh))
  (action  "./${<}")))

(rule
 ((targets (discover.exe))
  (deps    (discover.c openssl-ccopt openssl-cclib))
  (action "${CC} $(< openssl-ccopt) $(< openssl-cclib) -ldl discover.c -o discover.exe")))

(rule
 ((targets (config.h))
  (deps (discover.exe))
  (action "./${<} > config.h")))

(library
 ((name async_ssl_bindings)
  (public_name async_ssl.bindings)
  (libraries (ctypes.stubs ctypes))
  (virtual_deps (conf-openssl))
  (c_flags      (:include openssl-ccopt.sexp))
  (c_libraries  (:include openssl-cclib.sexp))
  (preprocessor_deps (config.h))))
